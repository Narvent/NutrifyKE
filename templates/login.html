<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Afyniq</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .cl-card {
            box-shadow: none !important;
            border: 1px solid #f3f4f6 !important;
        }

        .cl-socialButtonsBlockButton {
            border-radius: 0.75rem !important;
        }

        .cl-formButtonPrimary {
            background-color: #059669 !important;
            border-radius: 0.75rem !important;
        }
    </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen px-4">
    <div class="w-full max-w-md">
        <!-- Error Container (Hidden by default) -->
        <div id="config-error" class="hidden bg-red-50 border border-red-200 p-6 rounded-xl text-center">
            <div class="text-red-500 mb-4 text-center flex justify-center">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Login Unavailable</h2>
            <p id="error-message" class="text-gray-600 text-sm mb-4">
                We're having trouble connecting to the authentication service.
            </p>
            <a href="/login" class="text-emerald-600 hover:underline font-medium">Try again</a>
        </div>

        <div id="sign-in"></div>
    </div>

    {% if clerk_frontend_api and clerk_publishable_key %}
    <script async crossorigin="anonymous"
        src="https://{{ clerk_frontend_api }}/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        data-clerk-publishable-key="{{ clerk_publishable_key }}">
        </script>
    <script>
        console.log("Clerk Config:", { fapi: "{{ clerk_frontend_api }}", pk: "{{ clerk_publishable_key[:10] }}..." });

        window.addEventListener('load', async function () {
            const signInDiv = document.getElementById('sign-in');
            const errorDiv = document.getElementById('config-error');
            const errMsg = document.getElementById('error-message');

            try {
                if (typeof Clerk === 'undefined') {
                    // Wait a bit more if script is still loading (async)
                    console.log("Clerk not ready, waiting...");
                    let retries = 0;
                    while (typeof Clerk === 'undefined' && retries < 10) {
                        await new Promise(r => setTimeout(r, 500));
                        retries++;
                    }
                }

                if (typeof Clerk === 'undefined') {
                    throw new Error('Clerk JS failed to load from {{ clerk_frontend_api }}');
                }

                console.log("Initializing Clerk...");
                await Clerk.load();
                console.log("Clerk loaded successfully");

                if (Clerk.user) {
                    console.log("User already active, syncing...");
                    await syncAndRedirect(Clerk.user);
                } else {
                    console.log("Mounting SignIn...");
                    Clerk.mountSignIn(signInDiv, {
                        appearance: { variables: { colorPrimary: '#059669' } },
                        afterSignInUrl: window.location.origin
                    });

                    Clerk.addListener(({ user }) => {
                        if (user) {
                            console.log("Login success, syncing...");
                            syncAndRedirect(user);
                        }
                    });
                }
            } catch (err) {
                console.error("Clerk initialization failed:", err);
                signInDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errMsg.innerText = "Error: " + err.message;
            }
        });

        async function syncAndRedirect(user) {
            try {
                const response = await fetch('/sync-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clerk_id: user.id,
                        email: user.primaryEmailAddress.emailAddress,
                        name: user.username || user.fullName || user.primaryEmailAddress.emailAddress.split('@')[0]
                    })
                });
                if (response.ok) {
                    window.location.href = "/";
                } else {
                    console.error("Sync failed:", await response.text());
                }
            } catch (err) {
                console.error("Sync error:", err);
            }
        }
    </script>
    {% else %}
    <script>
        window.addEventListener('load', function () {
            document.getElementById('sign-in').classList.add('hidden');
            document.getElementById('config-error').classList.remove('hidden');
            const pk = "{{ clerk_publishable_key }}";
            const fapi = "{{ clerk_frontend_api }}";
            let missing = [];
            if (!pk || pk === 'None') missing.push("PUBLISHABLE_KEY");
            if (!fapi || fapi === 'None') missing.push("FRONTEND_API");
            document.getElementById('error-message').innerText = "Missing: " + missing.join(", ") + ". Please redeploy on Vercel after setting these variables.";
        });
    </script>
    {% endif %}
</body>

</html>