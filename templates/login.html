<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Afyniq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        /* Style Clerk to blend with our design */
        .cl-card {
            box-shadow: none !important;
            border: 1px solid #f3f4f6 !important;
        }

        .cl-socialButtonsBlockButton {
            border-radius: 0.75rem !important;
        }

        .cl-formButtonPrimary {
            background-color: #059669 !important;
            border-radius: 0.75rem !important;
        }
    </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen px-4">
    <div class="w-full max-w-md">
        <!-- Error Container (Hidden by default) -->
        <div id="config-error" class="hidden bg-red-50 border border-red-200 p-6 rounded-xl text-center">
            <div class="text-red-500 mb-4">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Configuration Missing</h2>
            <p class="text-gray-600 text-sm mb-4">
                The application is missing some required security keys (Clerk).
                If you are the developer, please ensure <code>PUBLIC_KEY</code> and <code>CLERK_FRONTEND_API</code> are
                set in Vercel.
            </p>
            <a href="/" class="text-indigo-600 hover:underline font-medium">Try reloading</a>
        </div>

        <div id="sign-in"></div>
    </div>

    {% if clerk_frontend_api and clerk_publishable_key %}
    <script async crossorigin="anonymous"
        src="https://{{ clerk_frontend_api }}/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        data-clerk-publishable-key="{{ clerk_publishable_key }}">
        </script>
    <script>
        window.addEventListener('load', async function () {
            try {
                if (typeof Clerk === 'undefined') {
                    throw new Error('Clerk not loaded');
                }
                await Clerk.load();

                if (Clerk.user) {
                    await syncAndRedirect(Clerk.user);
                } else {
                    Clerk.mountSignIn(document.getElementById('sign-in'), {
                        appearance: {
                            variables: { colorPrimary: '#059669' },
                        },
                        afterSignInUrl: '#',
                    });

                    Clerk.addListener(({ user }) => {
                        if (user) syncAndRedirect(user);
                    });
                }
            } catch (err) {
                console.error("Clerk Init Error:", err);
                document.getElementById('sign-in').classList.add('hidden');
                document.getElementById('config-error').classList.remove('hidden');
            }
        });

        async function syncAndRedirect(user) {
            const response = await fetch('/sync-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    clerk_id: user.id,
                    email: user.primaryEmailAddress.emailAddress,
                    name: user.fullName
                })
            });
            if (response.ok) {
                window.location.href = "{{ url_for('home') }}";
            }
        }
    </script>
    {% else %}
</body>

</html>